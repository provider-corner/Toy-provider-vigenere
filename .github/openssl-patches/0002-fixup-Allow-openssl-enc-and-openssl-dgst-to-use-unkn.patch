From 5fb91b4ec0b2c3da7b666b96e1902a6281db2406 Mon Sep 17 00:00:00 2001
From: Richard Levitte <levitte@openssl.org>
Date: Wed, 17 Feb 2021 09:29:44 +0100
Subject: [PATCH 2/2] fixup! Allow 'openssl enc' and 'openssl dgst' to use
 "unknown" ciphers and digests

---
 apps/ca.c       |  5 +++--
 apps/cms.c      | 11 ++++++++---
 apps/crl.c      |  5 +++--
 apps/dsa.c      |  4 +++-
 apps/ec.c       |  4 +++-
 apps/gendsa.c   |  4 +++-
 apps/genpkey.c  |  5 ++++-
 apps/genrsa.c   |  4 +++-
 apps/ocsp.c     |  7 +++++--
 apps/pkcs12.c   |  8 ++++++--
 apps/pkcs8.c    |  4 +++-
 apps/pkey.c     |  4 +++-
 apps/pkeyutl.c  |  4 +++-
 apps/req.c      |  6 ++++--
 apps/rsa.c      |  4 +++-
 apps/smime.c    |  8 ++++++--
 apps/storeutl.c |  4 +++-
 apps/ts.c       |  4 +++-
 apps/x509.c     |  4 +++-
 19 files changed, 72 insertions(+), 27 deletions(-)

diff --git a/apps/ca.c b/apps/ca.c
index 29f62f86f2..246f88753d 100755
--- a/apps/ca.c
+++ b/apps/ca.c
@@ -270,7 +270,7 @@ int ca_main(int argc, char **argv)
     STACK_OF(OPENSSL_STRING) *sigopts = NULL, *vfyopts = NULL;
     STACK_OF(X509) *cert_sk = NULL;
     X509_CRL *crl = NULL;
-    const EVP_MD *dgst = NULL;
+    const EVP_MD *dgst = NULL; EVP_MD *fetched_dgst = NULL;
     char *configfile = default_config_file, *section = NULL;
     char *md = NULL, *policy = NULL, *keyfile = NULL;
     char *certfile = NULL, *crl_ext = NULL, *crlnumberfile = NULL;
@@ -807,7 +807,7 @@ end_of_options:
             md = (char *)OBJ_nid2sn(def_nid);
         }
 
-        if (!opt_md(md, &dgst))
+        if (!opt_md(md, &dgst, &fetched_dgst))
             goto end;
     }
 
@@ -1312,6 +1312,7 @@ end_of_options:
  end:
     if (ret)
         ERR_print_errors(bio_err);
+    EVP_MD_free(fetched_dgst);
     BIO_free_all(Sout);
     BIO_free_all(out);
     BIO_free_all(in);
diff --git a/apps/cms.c b/apps/cms.c
index 67cbb9379a..75e6450536 100644
--- a/apps/cms.c
+++ b/apps/cms.c
@@ -277,7 +277,9 @@ int cms_main(int argc, char **argv)
     ENGINE *e = NULL;
     EVP_PKEY *key = NULL;
     const EVP_CIPHER *cipher = NULL, *wrap_cipher = NULL;
+    EVP_CIPHER *fetched_cipher = NULL, *fetched_wrap_cipher = NULL;
     const EVP_MD *sign_md = NULL;
+    EVP_MD *fetched_sign_md = NULL;
     STACK_OF(OPENSSL_STRING) *rr_to = NULL, *rr_from = NULL;
     STACK_OF(OPENSSL_STRING) *sksigners = NULL, *skkeys = NULL;
     STACK_OF(X509) *encerts = NULL, *other = NULL;
@@ -692,18 +694,18 @@ int cms_main(int argc, char **argv)
             wrap_cipher = EVP_aes_256_wrap();
             break;
         case OPT_WRAP:
-            if (!opt_cipher(opt_unknown(), &wrap_cipher))
+            if (!opt_cipher(opt_unknown(), &wrap_cipher, &fetched_wrap_cipher))
                 goto end;
             break;
         }
     }
     app_RAND_load();
     if (digestname != NULL) {
-        if (!opt_md(digestname, &sign_md))
+        if (!opt_md(digestname, &sign_md, &fetched_sign_md))
             goto end;
     }
     if (ciphername != NULL) {
-        if (!opt_cipher(ciphername, &cipher))
+        if (!opt_cipher(ciphername, &cipher, &fetched_cipher))
             goto end;
     }
 
@@ -1223,6 +1225,9 @@ int cms_main(int argc, char **argv)
  end:
     if (ret)
         ERR_print_errors(bio_err);
+    EVP_CIPHER_free(fetched_cipher);
+    EVP_CIPHER_free(fetched_wrap_cipher);
+    EVP_MD_free(fetched_sign_md);
     sk_X509_pop_free(encerts, X509_free);
     sk_X509_pop_free(other, X509_free);
     X509_VERIFY_PARAM_free(vpm);
diff --git a/apps/crl.c b/apps/crl.c
index dd9d41e8ea..a7449aec52 100644
--- a/apps/crl.c
+++ b/apps/crl.c
@@ -82,7 +82,7 @@ int crl_main(int argc, char **argv)
     X509_LOOKUP *lookup = NULL;
     X509_OBJECT *xobj = NULL;
     EVP_PKEY *pkey;
-    const EVP_MD *digest = EVP_sha1();
+    const EVP_MD *digest = EVP_sha1(); EVP_MD *fetched_digest = NULL;
     char *infile = NULL, *outfile = NULL, *crldiff = NULL, *keyfile = NULL;
     char *digestname = NULL;
     const char *CAfile = NULL, *CApath = NULL, *CAstore = NULL, *prog;
@@ -208,7 +208,7 @@ int crl_main(int argc, char **argv)
         goto opthelp;
 
     if (digestname != NULL) {
-        if (!opt_md(digestname, &digest))
+        if (!opt_md(digestname, &digest, &fetched_digest))
             goto opthelp;
     }
     x = load_crl(infile, "CRL");
@@ -378,6 +378,7 @@ int crl_main(int argc, char **argv)
  end:
     if (ret != 0)
         ERR_print_errors(bio_err);
+    EVP_MD_free(fetched_digest);
     BIO_free_all(out);
     X509_CRL_free(x);
     X509_STORE_CTX_free(ctx);
diff --git a/apps/dsa.c b/apps/dsa.c
index c4baaf7de9..100275d0e9 100644
--- a/apps/dsa.c
+++ b/apps/dsa.c
@@ -80,6 +80,7 @@ int dsa_main(int argc, char **argv)
     ENGINE *e = NULL;
     EVP_PKEY *pkey = NULL;
     const EVP_CIPHER *enc = NULL;
+    EVP_CIPHER *fetched_enc = NULL;
     char *infile = NULL, *outfile = NULL, *prog;
     char *passin = NULL, *passout = NULL, *passinarg = NULL, *passoutarg = NULL;
     OPTION_CHOICE o;
@@ -166,7 +167,7 @@ int dsa_main(int argc, char **argv)
         goto opthelp;
 
     if (ciphername != NULL) {
-        if (!opt_cipher(ciphername, &enc))
+        if (!opt_cipher(ciphername, &enc, &fetched_enc))
             goto end;
     }
     private = pubin || pubout ? 0 : 1;
@@ -286,6 +287,7 @@ int dsa_main(int argc, char **argv)
  end:
     if (ret != 0)
         ERR_print_errors(bio_err);
+    EVP_CIPHER_free(fetched_enc);
     OSSL_ENCODER_CTX_free(ectx);
     BIO_free_all(out);
     EVP_PKEY_free(pkey);
diff --git a/apps/ec.c b/apps/ec.c
index d89c580020..74b1389e16 100644
--- a/apps/ec.c
+++ b/apps/ec.c
@@ -70,6 +70,7 @@ int ec_main(int argc, char **argv)
     BIO *in = NULL, *out = NULL;
     ENGINE *e = NULL;
     const EVP_CIPHER *enc = NULL;
+    EVP_CIPHER *fetched_enc = NULL;
     char *infile = NULL, *outfile = NULL, *ciphername = NULL, *prog;
     char *passin = NULL, *passout = NULL, *passinarg = NULL, *passoutarg = NULL;
     OPTION_CHOICE o;
@@ -162,7 +163,7 @@ int ec_main(int argc, char **argv)
         goto opthelp;
 
     if (ciphername != NULL) {
-        if (!opt_cipher(ciphername, &enc))
+        if (!opt_cipher(ciphername, &enc, &fetched_enc))
             goto opthelp;
     }
     private = param_out || pubin || pubout ? 0 : 1;
@@ -276,6 +277,7 @@ int ec_main(int argc, char **argv)
 end:
     if (ret != 0)
         ERR_print_errors(bio_err);
+    EVP_CIPHER_free(fetched_enc);
     BIO_free(in);
     BIO_free_all(out);
     EVP_PKEY_free(eckey);
diff --git a/apps/gendsa.c b/apps/gendsa.c
index c6c84c9a56..6fa31255b1 100644
--- a/apps/gendsa.c
+++ b/apps/gendsa.c
@@ -57,6 +57,7 @@ int gendsa_main(int argc, char **argv)
     EVP_PKEY *pkey = NULL;
     EVP_PKEY_CTX *ctx = NULL;
     const EVP_CIPHER *enc = NULL;
+    EVP_CIPHER *fetched_enc = NULL;
     char *dsaparams = NULL, *ciphername = NULL;
     char *outfile = NULL, *passoutarg = NULL, *passout = NULL, *prog;
     OPTION_CHOICE o;
@@ -110,7 +111,7 @@ int gendsa_main(int argc, char **argv)
 
     app_RAND_load();
     if (ciphername != NULL) {
-        if (!opt_cipher(ciphername, &enc))
+        if (!opt_cipher(ciphername, &enc, &fetched_enc))
             goto end;
     }
     private = 1;
@@ -160,6 +161,7 @@ int gendsa_main(int argc, char **argv)
     if (ret != 0)
         ERR_print_errors(bio_err);
  end2:
+    EVP_CIPHER_free(fetched_enc);
     BIO_free(in);
     BIO_free_all(out);
     EVP_PKEY_free(pkey);
diff --git a/apps/genpkey.c b/apps/genpkey.c
index 4d28b4ecc2..76badd118d 100644
--- a/apps/genpkey.c
+++ b/apps/genpkey.c
@@ -65,6 +65,7 @@ int genpkey_main(int argc, char **argv)
     char *outfile = NULL, *passarg = NULL, *pass = NULL, *prog, *p;
     const char *ciphername = NULL, *paramfile = NULL, *algname = NULL;
     const EVP_CIPHER *cipher = NULL;
+    EVP_CIPHER *fetched_cipher = NULL;
     OPTION_CHOICE o;
     int outformat = FORMAT_PEM, text = 0, ret = 1, rv, do_param = 0;
     int private = 0, i, m;
@@ -158,7 +159,8 @@ int genpkey_main(int argc, char **argv)
         }
     }
     if (ciphername != NULL) {
-        if (!opt_cipher(ciphername, &cipher) || do_param == 1)
+        if (!opt_cipher(ciphername, &cipher, &fetched_cipher)
+            || do_param == 1)
             goto opthelp;
         m = EVP_CIPHER_mode(cipher);
         if (m == EVP_CIPH_GCM_MODE || m == EVP_CIPH_CCM_MODE
@@ -231,6 +233,7 @@ int genpkey_main(int argc, char **argv)
     }
 
  end:
+    EVP_CIPHER_free(fetched_cipher);
     sk_OPENSSL_STRING_free(keyopt);
     EVP_PKEY_free(pkey);
     EVP_PKEY_CTX_free(ctx);
diff --git a/apps/genrsa.c b/apps/genrsa.c
index cd99b53a3b..d514267f0d 100644
--- a/apps/genrsa.c
+++ b/apps/genrsa.c
@@ -83,6 +83,7 @@ int genrsa_main(int argc, char **argv)
     EVP_PKEY *pkey = NULL;
     EVP_PKEY_CTX *ctx = NULL;
     const EVP_CIPHER *enc = NULL;
+    EVP_CIPHER *fetched_enc = NULL;
     int ret = 1, num = DEFBITS, private = 0, primes = DEFPRIMES;
     unsigned long f4 = RSA_F4;
     char *outfile = NULL, *passoutarg = NULL, *passout = NULL;
@@ -166,7 +167,7 @@ opthelp:
     app_RAND_load();
     private = 1;
     if (ciphername != NULL) {
-        if (!opt_cipher(ciphername, &enc))
+        if (!opt_cipher(ciphername, &enc, &fetched_enc))
             goto end;
     }
     if (!app_passwd(NULL, passoutarg, NULL, &passout)) {
@@ -237,6 +238,7 @@ opthelp:
 
     ret = 0;
  end:
+    EVP_CIPHER_free(fetched_enc);
     BN_free(bn);
     BN_GENCB_free(cb);
     EVP_PKEY_CTX_free(ctx);
diff --git a/apps/ocsp.c b/apps/ocsp.c
index dd1677b1c1..ee71681b24 100644
--- a/apps/ocsp.c
+++ b/apps/ocsp.c
@@ -204,6 +204,7 @@ int ocsp_main(int argc, char **argv)
 {
     BIO *acbio = NULL, *cbio = NULL, *derbio = NULL, *out = NULL;
     const EVP_MD *cert_id_md = NULL, *rsign_md = NULL;
+    EVP_MD *fetched_cert_id_md = NULL, *fetched_rsign_md = NULL;
     STACK_OF(OPENSSL_STRING) *rsign_sigopts = NULL;
     int trailing_md = 0;
     CA_DB *rdb = NULL;
@@ -498,7 +499,7 @@ int ocsp_main(int argc, char **argv)
                            prog);
                 goto opthelp;
             }
-            if (!opt_md(opt_unknown(), &cert_id_md))
+            if (!opt_md(opt_unknown(), &cert_id_md, &fetched_cert_id_md))
                 goto opthelp;
             trailing_md = 1;
             break;
@@ -526,7 +527,7 @@ int ocsp_main(int argc, char **argv)
     }
 
     if (respdigname != NULL) {
-        if (!opt_md(respdigname, &rsign_md))
+        if (!opt_md(respdigname, &rsign_md, &fetched_rsign_md))
             goto end;
     }
 
@@ -822,6 +823,8 @@ redo_accept:
         ret = 1;
 
  end:
+    EVP_MD_free(fetched_cert_id_md);
+    EVP_MD_free(fetched_rsign_md);
     ERR_print_errors(bio_err);
     X509_free(signer);
     X509_STORE_free(store);
diff --git a/apps/pkcs12.c b/apps/pkcs12.c
index e96f9ec4a4..273ab38a49 100644
--- a/apps/pkcs12.c
+++ b/apps/pkcs12.c
@@ -166,6 +166,7 @@ int pkcs12_main(int argc, char **argv)
     STACK_OF(OPENSSL_STRING) *canames = NULL;
     const EVP_CIPHER *const default_enc = EVP_aes_256_cbc();
     const EVP_CIPHER *enc = default_enc;
+    EVP_CIPHER *fetched_enc = NULL;
     OPTION_CHOICE o;
 
     prog = opt_init(argc, argv, pkcs12_options);
@@ -346,7 +347,7 @@ int pkcs12_main(int argc, char **argv)
 
     app_RAND_load();
     if (ciphername != NULL) {
-        if (!opt_cipher(ciphername, &enc))
+        if (!opt_cipher(ciphername, &enc, &fetched_enc))
             goto opthelp;
     }
     if (export_pkcs12) {
@@ -497,6 +498,7 @@ int pkcs12_main(int argc, char **argv)
         STACK_OF(X509) *certs = NULL;
         STACK_OF(X509) *untrusted_certs = NULL;
         const EVP_MD *macmd = NULL;
+        EVP_MD *fetched_macmd = NULL;
         unsigned char *catmp = NULL;
         int i;
 
@@ -650,7 +652,7 @@ int pkcs12_main(int argc, char **argv)
         }
 
         if (macalg != NULL) {
-            if (!opt_md(macalg, &macmd))
+            if (!opt_md(macalg, &macmd, &fetched_macmd))
                 goto opthelp;
         }
 
@@ -669,6 +671,7 @@ int pkcs12_main(int argc, char **argv)
 
  export_end:
 
+        EVP_MD_free(fetched_macmd);
         EVP_PKEY_free(key);
         sk_X509_pop_free(certs, X509_free);
         sk_X509_pop_free(untrusted_certs, X509_free);
@@ -767,6 +770,7 @@ int pkcs12_main(int argc, char **argv)
     }
     ret = 0;
  end:
+    EVP_CIPHER_free(fetched_enc);
     PKCS12_free(p12);
     release_engine(e);
     BIO_free(in);
diff --git a/apps/pkcs8.c b/apps/pkcs8.c
index 674007498a..74700b47ab 100644
--- a/apps/pkcs8.c
+++ b/apps/pkcs8.c
@@ -75,6 +75,7 @@ int pkcs8_main(int argc, char **argv)
     PKCS8_PRIV_KEY_INFO *p8inf = NULL;
     X509_SIG *p8 = NULL;
     const EVP_CIPHER *cipher = NULL;
+    EVP_CIPHER *fetched_cipher = NULL;
     char *infile = NULL, *outfile = NULL, *ciphername = NULL;
     char *passinarg = NULL, *passoutarg = NULL, *prog;
 #ifndef OPENSSL_NO_UI_CONSOLE
@@ -201,7 +202,7 @@ int pkcs8_main(int argc, char **argv)
     private = 1;
     app_RAND_load();
     if (ciphername != NULL) {
-        if (!opt_cipher(ciphername, &cipher))
+        if (!opt_cipher(ciphername, &cipher, &fetched_cipher))
             goto opthelp;
     }
 
@@ -365,6 +366,7 @@ int pkcs8_main(int argc, char **argv)
     ret = 0;
 
  end:
+    EVP_CIPHER_free(fetched_cipher);
     X509_SIG_free(p8);
     PKCS8_PRIV_KEY_INFO_free(p8inf);
     EVP_PKEY_free(pkey);
diff --git a/apps/pkey.c b/apps/pkey.c
index 1a53447401..24e7071755 100644
--- a/apps/pkey.c
+++ b/apps/pkey.c
@@ -72,6 +72,7 @@ int pkey_main(int argc, char **argv)
     EVP_PKEY *pkey = NULL;
     EVP_PKEY_CTX *ctx = NULL;
     const EVP_CIPHER *cipher = NULL;
+    EVP_CIPHER *fetched_cipher = NULL;
     char *infile = NULL, *outfile = NULL, *passin = NULL, *passout = NULL;
     char *passinarg = NULL, *passoutarg = NULL, *ciphername = NULL, *prog;
     OPTION_CHOICE o;
@@ -187,7 +188,7 @@ int pkey_main(int argc, char **argv)
     private = (!noout && !pubout) || (text && !text_pub);
 
     if (ciphername != NULL) {
-        if (!opt_cipher(ciphername, &cipher))
+        if (!opt_cipher(ciphername, &cipher, &fetched_cipher))
             goto opthelp;
     }
     if (cipher == NULL) {
@@ -323,6 +324,7 @@ int pkey_main(int argc, char **argv)
  end:
     if (ret != 0)
         ERR_print_errors(bio_err);
+    EVP_CIPHER_free(fetched_cipher);
     EVP_PKEY_CTX_free(ctx);
     EVP_PKEY_free(pkey);
     release_engine(e);
diff --git a/apps/pkeyutl.c b/apps/pkeyutl.c
index b70f9935b6..597df9fcbd 100644
--- a/apps/pkeyutl.c
+++ b/apps/pkeyutl.c
@@ -123,6 +123,7 @@ int pkeyutl_main(int argc, char **argv)
     STACK_OF(OPENSSL_STRING) *pkeyopts_passin = NULL;
     int rawin = 0;
     const EVP_MD *md = NULL;
+    EVP_MD *fetched_md = NULL;
     int filesize = -1;
     OSSL_LIB_CTX *libctx = app_get0_libctx();
 
@@ -256,7 +257,7 @@ int pkeyutl_main(int argc, char **argv)
 
     app_RAND_load();
     if (digestname != NULL) {
-        if (!opt_md(digestname, &md))
+        if (!opt_md(digestname, &md, &fetched_md))
             goto end;
     }
 
@@ -500,6 +501,7 @@ int pkeyutl_main(int argc, char **argv)
     }
 
  end:
+    EVP_MD_free(fetched_md);
     EVP_PKEY_CTX_free(ctx);
     release_engine(e);
     BIO_free(in);
diff --git a/apps/req.c b/apps/req.c
index 881cbb45c7..befbe57c94 100644
--- a/apps/req.c
+++ b/apps/req.c
@@ -241,6 +241,7 @@ int req_main(int argc, char **argv)
     X509_REQ *req = NULL;
     const EVP_CIPHER *cipher = NULL;
     const EVP_MD *md_alg = NULL, *digest = NULL;
+    EVP_MD *fetched_md_alg = NULL, *fetched_digest = NULL;
     int ext_copy = EXT_COPY_UNSET;
     BIO *addext_bio = NULL;
     char *extensions = NULL;
@@ -480,7 +481,7 @@ int req_main(int argc, char **argv)
 
     app_RAND_load();
     if (digestname != NULL) {
-        if (!opt_md(digestname, &md_alg))
+        if (!opt_md(digestname, &md_alg, &fetched_md_alg))
             goto opthelp;
         digest = md_alg;
     }
@@ -539,7 +540,7 @@ int req_main(int argc, char **argv)
         if (p == NULL) {
             ERR_clear_error();
         } else {
-            if (!opt_md(p, &md_alg))
+            if (!opt_md(p, &md_alg, &fetched_md_alg))
                 goto opthelp;
             digest = md_alg;
         }
@@ -1060,6 +1061,7 @@ int req_main(int argc, char **argv)
     NCONF_free(addext_conf);
     BIO_free(addext_bio);
     BIO_free_all(out);
+    EVP_MD_free(fetched_digest);
     EVP_PKEY_free(pkey);
     EVP_PKEY_CTX_free(genctx);
     sk_OPENSSL_STRING_free(pkeyopts);
diff --git a/apps/rsa.c b/apps/rsa.c
index 1a75681c70..4674224d08 100644
--- a/apps/rsa.c
+++ b/apps/rsa.c
@@ -93,6 +93,7 @@ int rsa_main(int argc, char **argv)
     EVP_PKEY *pkey = NULL;
     EVP_PKEY_CTX *pctx;
     const EVP_CIPHER *enc = NULL;
+    EVP_CIPHER *fetched_enc = NULL;
     char *infile = NULL, *outfile = NULL, *ciphername = NULL, *prog;
     char *passin = NULL, *passout = NULL, *passinarg = NULL, *passoutarg = NULL;
     int private = 0;
@@ -189,7 +190,7 @@ int rsa_main(int argc, char **argv)
         goto opthelp;
 
     if (ciphername != NULL) {
-        if (!opt_cipher(ciphername, &enc))
+        if (!opt_cipher(ciphername, &enc, &fetched_enc))
             goto opthelp;
     }
     private = (text && !pubin) || (!pubout && !noout) ? 1 : 0;
@@ -360,6 +361,7 @@ int rsa_main(int argc, char **argv)
     }
     ret = 0;
  end:
+    EVP_CIPHER_free(fetched_enc);
     OSSL_ENCODER_CTX_free(ectx);
     release_engine(e);
     BIO_free_all(out);
diff --git a/apps/smime.c b/apps/smime.c
index 63578f28d5..6fbc12c065 100644
--- a/apps/smime.c
+++ b/apps/smime.c
@@ -141,7 +141,9 @@ int smime_main(int argc, char **argv)
     X509_STORE *store = NULL;
     X509_VERIFY_PARAM *vpm = NULL;
     const EVP_CIPHER *cipher = NULL;
+    EVP_CIPHER *fetched_cipher = NULL;
     const EVP_MD *sign_md = NULL;
+    EVP_MD *fetched_sign_md = NULL;
     const char *CAfile = NULL, *CApath = NULL, *CAstore = NULL, *prog = NULL;
     char *certfile = NULL, *keyfile = NULL, *contfile = NULL;
     char *infile = NULL, *outfile = NULL, *signerfile = NULL, *recipfile = NULL;
@@ -361,11 +363,11 @@ int smime_main(int argc, char **argv)
 
     app_RAND_load();
     if (digestname != NULL) {
-        if (!opt_md(digestname, &sign_md))
+        if (!opt_md(digestname, &sign_md, &fetched_sign_md))
             goto opthelp;
     }
     if (ciphername != NULL) {
-        if (!opt_cipher(ciphername, &cipher))
+        if (!opt_cipher(ciphername, &cipher, &fetched_cipher))
             goto opthelp;
     }
     if (!(operation & SMIME_SIGNERS) && (skkeys != NULL || sksigners != NULL)) {
@@ -650,6 +652,8 @@ int smime_main(int argc, char **argv)
  end:
     if (ret)
         ERR_print_errors(bio_err);
+    EVP_CIPHER_free(fetched_cipher);
+    EVP_MD_free(fetched_sign_md);
     sk_X509_pop_free(encerts, X509_free);
     sk_X509_pop_free(other, X509_free);
     X509_VERIFY_PARAM_free(vpm);
diff --git a/apps/storeutl.c b/apps/storeutl.c
index 7c13092fe5..9e406ffaa4 100644
--- a/apps/storeutl.c
+++ b/apps/storeutl.c
@@ -84,6 +84,7 @@ int storeutl_main(int argc, char *argv[])
     char *alias = NULL, *digestname = NULL;
     OSSL_STORE_SEARCH *search = NULL;
     const EVP_MD *digest = NULL;
+    EVP_MD *fetched_digest = NULL;
     OSSL_LIB_CTX *libctx = app_get0_libctx();
 
     while ((o = opt_next()) != OPT_EOF) {
@@ -263,7 +264,7 @@ int storeutl_main(int argc, char *argv[])
         goto opthelp;
 
     if (digestname != NULL) {
-        if (!opt_md(digestname, &digest))
+        if (!opt_md(digestname, &digest, &fetched_digest))
             goto opthelp;
     }
 
@@ -322,6 +323,7 @@ int storeutl_main(int argc, char *argv[])
                   text, noout, recursive, 0, out, prog, libctx);
 
  end:
+    EVP_MD_free(fetched_digest);
     OPENSSL_free(fingerprint);
     OPENSSL_free(alias);
     ASN1_INTEGER_free(serial);
diff --git a/apps/ts.c b/apps/ts.c
index 8500968a0c..3a6c2bc80c 100644
--- a/apps/ts.c
+++ b/apps/ts.c
@@ -168,6 +168,7 @@ int ts_main(int argc, char **argv)
     char *inkey = NULL, *signer = NULL, *chain = NULL, *CApath = NULL;
     char *CAstore = NULL;
     const EVP_MD *md = NULL;
+    EVP_MD *fetched_md = NULL;
     OPTION_CHOICE o, mode = OPT_ERR;
     int ret = 1, no_nonce = 0, cert = 0, text = 0;
     int vpmtouched = 0;
@@ -293,7 +294,7 @@ int ts_main(int argc, char **argv)
 
     app_RAND_load();
     if (digestname != NULL) {
-        if (!opt_md(digestname, &md))
+        if (!opt_md(digestname, &md, &fetched_md))
             goto opthelp;
     }
     if (mode == OPT_REPLY && passin &&
@@ -339,6 +340,7 @@ int ts_main(int argc, char **argv)
     }
 
  end:
+    EVP_MD_free(fetched_md);
     X509_VERIFY_PARAM_free(vpm);
     NCONF_free(conf);
     OPENSSL_free(password);
diff --git a/apps/x509.c b/apps/x509.c
index 67895c8169..8cd60580c8 100644
--- a/apps/x509.c
+++ b/apps/x509.c
@@ -256,6 +256,7 @@ int x509_main(int argc, char **argv)
     X509_REQ *req = NULL, *rq = NULL;
     X509_STORE *ctx = NULL;
     const EVP_MD *digest = NULL;
+    EVP_MD *fetched_digest = NULL;
     char *CAkeyfile = NULL, *CAserial = NULL, *pubkeyfile = NULL, *alias = NULL;
     char *checkhost = NULL, *checkemail = NULL, *checkip = NULL;
     char *ext_names = NULL;
@@ -581,7 +582,7 @@ int x509_main(int argc, char **argv)
 
     app_RAND_load();
     if (digestname != NULL) {
-        if (!opt_md(digestname, &digest))
+        if (!opt_md(digestname, &digest, &fetched_digest))
             goto opthelp;
     }
     if (preserve_dates && days != UNSET_DAYS) {
@@ -1078,6 +1079,7 @@ int x509_main(int argc, char **argv)
     X509_REQ_free(req);
     X509_free(x);
     X509_free(xca);
+    EVP_MD_free(fetched_digest);
     EVP_PKEY_free(signkey);
     EVP_PKEY_free(CAkey);
     EVP_PKEY_free(pubkey);
-- 
2.30.0

